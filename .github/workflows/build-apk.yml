name: Build and Sign Release APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  API_LEVEL: "34"
  BUILD_TOOLS: "34.0.0"
  OUTPUT_DIR: "app/build/outputs/apk/release"
  DEFAULT_KEYSTORE_ALIAS: "lostmodekey"
  DEFAULT_KEYSTORE_PASS: "android"
  DEFAULT_KEY_PASS: "android"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # install cmdline-tools (we will call sdkmanager manually to avoid quoting issues)
      - name: Setup Android cmdline-tools
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 12266719
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: true

      - name: Install SDK components (manual sdkmanager call)
        run: |
          set -e
          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          echo "sdkmanager: $SDKMANAGER"
          if [ ! -x "$SDKMANAGER" ]; then
            echo "ERROR: sdkmanager not found at $SDKMANAGER"
            ls -R "$ANDROID_SDK_ROOT" || true
            exit 1
          fi
          yes | "$SDKMANAGER" "platform-tools" "platforms;android-${{ env.API_LEVEL }}" "build-tools;${{ env.BUILD_TOOLS }}" || ( echo "sdkmanager failed" && exit 1 )
          echo "Installed SDK components."

      - name: Force accept any remaining licenses (fail-safe)
        run: yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build release APK
        run: ./gradlew clean assembleRelease --no-daemon

      - name: Locate unsigned APK
        id: locate
        run: |
          set -e
          OUTPUT="${GITHUB_WORKSPACE}/${{ env.OUTPUT_DIR }}"
          APK_UNSIGNED=$(find "$OUTPUT" -type f -name '*-unsigned.apk' -print | head -n 1 || true)
          if [ -z "$APK_UNSIGNED" ]; then
            APK_UNSIGNED=$(find "$OUTPUT" -type f -name '*.apk' -print | head -n 1 || true)
          fi
          if [ -z "$APK_UNSIGNED" ]; then
            echo "ERROR: No APK found in $OUTPUT"
            ls -R "$OUTPUT" || true
            exit 1
          fi
          echo "Located unsigned APK: $APK_UNSIGNED"
          echo "APK_UNSIGNED=$APK_UNSIGNED" >> $GITHUB_ENV
          echo "apk_unsigned=$APK_UNSIGNED" >> $GITHUB_OUTPUT

      - name: Setup keystore (secret or debug fallback)
        id: keystore
        run: |
          set -e
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            printf '%s' "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
            KEYSTORE_PATH=release.keystore
            KEYSTORE_ALIAS="${{ secrets.KEYSTORE_ALIAS }}"
            KEYSTORE_PASSWORD="${{ secrets.KEYSTORE_PASSWORD }}"
            KEY_PASSWORD="${{ secrets.KEY_PASSWORD }}"
            echo "Using release keystore from secrets"
          else
            echo "No KEYSTORE_BASE64 found â€” generating temporary debug.keystore (not for Play Store)"
            keytool -genkey -v \
              -keystore debug.keystore \
              -alias "${{ env.DEFAULT_KEYSTORE_ALIAS }}" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass "${{ env.DEFAULT_KEYSTORE_PASS }}" \
              -keypass "${{ env.DEFAULT_KEY_PASS }}" \
              -dname "CN=LostMode, OU=Dev, O=LostMode, L=City, ST=State, C=US"
            KEYSTORE_PATH=debug.keystore
            KEYSTORE_ALIAS="${{ env.DEFAULT_KEYSTORE_ALIAS }}"
            KEYSTORE_PASSWORD="${{ env.DEFAULT_KEYSTORE_PASS }}"
            KEY_PASSWORD="${{ env.DEFAULT_KEY_PASS }}"
          fi
          echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> $GITHUB_ENV
          echo "KEYSTORE_ALIAS=$KEYSTORE_ALIAS" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
          echo "keystore_path=$KEYSTORE_PATH" >> $GITHUB_OUTPUT
          echo "keystore_alias=$KEYSTORE_ALIAS" >> $GITHUB_OUTPUT

      - name: Find build-tools directory
        id: buildtools
        run: |
          set -e
          BUILD_TOOLS_DIR=$(ls -d "$ANDROID_SDK_ROOT"/build-tools/* 2>/dev/null | sort -V | tail -n1 || true)
          if [ -z "$BUILD_TOOLS_DIR" ]; then
            echo "ERROR: No build-tools found under $ANDROID_SDK_ROOT/build-tools"
            ls -R "$ANDROID_SDK_ROOT" || true
            exit 1
          fi
          echo "BUILD_TOOLS_DIR=$BUILD_TOOLS_DIR" >> $GITHUB_ENV
          echo "build_tools_dir=$BUILD_TOOLS_DIR" >> $GITHUB_OUTPUT

      # ---------- IMPORTANT: zipalign BEFORE signing ----------
      - name: Zipalign unsigned APK (prepare before signing)
        run: |
          set -e
          BUILD_TOOLS_DIR="${{ steps.buildtools.outputs.build_tools_dir }}"
          APK_UNSIGNED="${APK_UNSIGNED:-${{ steps.locate.outputs.apk_unsigned }}}"
          if [ -z "$APK_UNSIGNED" ]; then
            echo "ERROR: APK unsigned path is empty"
            exit 1
          fi
          OUT_ALIGNED_UNSIGNED="$GITHUB_WORKSPACE/${{ env.OUTPUT_DIR }}/app-release-aligned-unsigned.apk"
          echo "Zipaligning unsigned APK: $APK_UNSIGNED -> $OUT_ALIGNED_UNSIGNED (using $BUILD_TOOLS_DIR/zipalign)"
          "$BUILD_TOOLS_DIR/zipalign" -v -f 4 "$APK_UNSIGNED" "$OUT_ALIGNED_UNSIGNED"
          echo "ALIGNED_UNSIGNED_APK=$OUT_ALIGNED_UNSIGNED" >> $GITHUB_ENV
          echo "aligned_unsigned=$OUT_ALIGNED_UNSIGNED" >> $GITHUB_OUTPUT
          ls -l "$OUT_ALIGNED_UNSIGNED" || true

      - name: Sign aligned APK (use apksigner; enable v1/v2/v3)
        run: |
          set -e
          BUILD_TOOLS_DIR="${{ steps.buildtools.outputs.build_tools_dir }}"
          IN_ALIGNED="$GITHUB_WORKSPACE/${{ env.OUTPUT_DIR }}/app-release-aligned-unsigned.apk"
          if [ ! -f "$IN_ALIGNED" ]; then
            # fallback to step output
            IN_ALIGNED="${{ steps.locate.outputs.apk_unsigned }}"
          fi
          OUT_SIGNED="$GITHUB_WORKSPACE/${{ env.OUTPUT_DIR }}/app-release-signed.apk"
          echo "Signing aligned APK: $IN_ALIGNED -> $OUT_SIGNED using $BUILD_TOOLS_DIR/apksigner"
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks "$KEYSTORE_PATH" \
            --ks-key-alias "$KEYSTORE_ALIAS" \
            --ks-pass "pass:$KEYSTORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            --v3-signing-enabled true \
            --out "$OUT_SIGNED" \
            "$IN_ALIGNED"
          echo "SIGNED_APK_PATH=$OUT_SIGNED" >> $GITHUB_ENV
          ls -l "$OUT_SIGNED" || true

      - name: Verify signed APK
        run: |
          set -e
          BUILD_TOOLS_DIR="${{ steps.buildtools.outputs.build_tools_dir }}"
          SIGNED="$GITHUB_WORKSPACE/${{ env.OUTPUT_DIR }}/app-release-signed.apk"
          if [ ! -f "$SIGNED" ]; then
            echo "ERROR: Signed APK not found at $SIGNED"
            ls -R "${GITHUB_WORKSPACE}/${{ env.OUTPUT_DIR }}" || true
            exit 1
          fi
          echo "Verifying signed APK with apksigner:"
          "$BUILD_TOOLS_DIR/apksigner" verify --print-certs "$SIGNED"
          echo "Verified: $SIGNED"

      - name: Upload final APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LostModeClient-APK
          path: ${{ github.workspace }}/${{ env.OUTPUT_DIR }}/app-release-signed.apk